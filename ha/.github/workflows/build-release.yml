name: Build and Release Reachy Mini 3D Card

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
    paths:
      - 'ha/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'ha/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ha/package-lock.json

      - name: Install dependencies
        working-directory: ./ha
        run: npm ci

      - name: Run linter
        working-directory: ./ha
        run: npm run lint --if-present
        continue-on-error: true

      - name: Build bundle
        working-directory: ./ha
        run: |
          npm run build
          echo "Build completed successfully"

      - name: Create release package
        working-directory: ./ha
        run: |
          VERSION=$(node -p "require('./package.json').version")
          mkdir -p dist

          # Create package structure
          mkdir -p build/reachy-mini-3d-card
          cp reachy-mini-3d-card.js build/reachy-mini-3d-card/ 2>/dev/null || echo "No bundled file yet"
          cp -r assets build/reachy-mini-3d-card/
          cp hacs.json build/reachy-mini-3d-card/
          cp README.md build/reachy-mini-3d-card/
          cp LICENSE build/reachy-mini-3d-card/ 2>/dev/null || true

          # If bundled file exists, use it
          if [ -f reachy-mini-3d-card.js ]; then
            cp reachy-mini-3d-card.js build/reachy-mini-3d-card/
          fi

          # Create ZIP
          cd build
          zip -r ../dist/reachy-mini-3d-card.zip reachy-mini-3d-card/
          cd ..

          # Calculate checksums
          cd dist
          sha256sum reachy-mini-3d-card.zip > SHA256SUMS
          md5sum reachy-mini-3d-card.zip > MD5SUMS
          cd ..

          echo "Package created: dist/reachy-mini-3d-card.zip"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: reachy-mini-3d-card
          path: ha/dist/
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ha/dist/reachy-mini-3d-card.zip
          body: |
            ## ðŸš€ Reachy Mini 3D Card Release

            ### ðŸ“¦ Installation

            **Via HACS:**
            1. Open HACS in Home Assistant
            2. Go to Frontend â†’ Explore & Download Repositories
            3. Search for "Reachy Mini 3D Card"
            4. Click Download

            **Manual:**
            1. Download `reachy-mini-3d-card.zip`
            2. Extract to your Home Assistant `www` directory
            3. Add to Lovelace resources:
            ```yaml
            lovelace:
              resources:
                - url: /local/reachy-mini-3d-card/reachy-mini-3d-card.js
                  type: module
            ```

            ### âœ¨ What's New

            See [CHANGELOG.md](https://github.com/djhui5710/reachy_mini_ha_voice/blob/main/ha/CHANGELOG.md) for details.

            ### ðŸ“‹ Checksums

            **SHA256:** `${{ steps.build.outputs.sha256 }}`
            **MD5:** `${{ steps.build.outputs.md5 }}`

            ---
            <details>
            <summary>ðŸ“– Installation Instructions</summary>

            1. Download the zip file
            2. Extract to `/config/www/reachy-mini-3d-card/`
            3. Add to `configuration.yaml`:
            ```yaml
            lovelace:
              resources:
                - url: /local/reachy-mini-3d-card/reachy-mini-3d-card.js
                  type: module
            ```
            4. Restart Home Assistant
            5. Add card to dashboard:
            ```yaml
            type: custom:reachy-mini-3d-card
            entity_prefix: reachy_mini
            ```

            </details>

            ---
            **Full Changelog**: https://github.com/djhui5710/reachy_mini_ha_voice/compare/${{ github.ref_name }}...HEAD
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output checksums
        if: startsWith(github.ref, 'refs/tags/')
        working-directory: ./ha/dist
        run: |
          echo "## ðŸ“‹ Checksums" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat SHA256SUMS >> $GITHUB_STEP_SUMMARY
          cat MD5SUMS >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
